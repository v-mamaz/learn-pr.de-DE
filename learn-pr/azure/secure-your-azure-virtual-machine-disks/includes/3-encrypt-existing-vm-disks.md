<span data-ttu-id="07568-101">Angenommen, Ihr Unternehmen hat sich entschieden, Azure Disk Encryption (ADE) auf allen VMs zu implementieren.</span><span class="sxs-lookup"><span data-stu-id="07568-101">Suppose your company has decided to implement Azure Disk Encryption (ADE) across all VMs.</span></span> <span data-ttu-id="07568-102">In diesem Fall müssen Sie evaluieren, wie Sie den Rollout für die Verschlüsselung auf allen vorhandenen VM-Volumes durchführen.</span><span class="sxs-lookup"><span data-stu-id="07568-102">You need to evaluate how to roll out encryption to existing VM volumes.</span></span>

<span data-ttu-id="07568-103">Hier werden die Anforderungen für ADE und die Schritte zum Verschlüsseln von Datenträgern auf vorhandenen Windows-VMs beschrieben.</span><span class="sxs-lookup"><span data-stu-id="07568-103">Here, we'll look at the requirements for ADE, and the steps involved in encrypting disks on existing Windows VMs.</span></span>

## <a name="azure-disk-encryption-prerequisites"></a><span data-ttu-id="07568-104">Azure Disk Encryption – Voraussetzungen</span><span class="sxs-lookup"><span data-stu-id="07568-104">Azure Disk Encryption Prerequisites</span></span>

<span data-ttu-id="07568-105">Bevor Sie Ihren ersten VM-Datenträger verschlüsseln können, müssen Sie Folgendes durchführen:</span><span class="sxs-lookup"><span data-stu-id="07568-105">Before you can encrypt your first VM disk, you need to</span></span>

1. <span data-ttu-id="07568-106">Erstellen eines Schlüsseltresors</span><span class="sxs-lookup"><span data-stu-id="07568-106">Create a key vault</span></span>
1. <span data-ttu-id="07568-107">Einrichten einer Azure AD-Anwendung und eines Dienstprinzipals</span><span class="sxs-lookup"><span data-stu-id="07568-107">Set up an Azure AD application and service principal</span></span>
1. <span data-ttu-id="07568-108">Festlegen der Zugriffsrichtlinie für den Schlüsseltresor für die Azure AD-App</span><span class="sxs-lookup"><span data-stu-id="07568-108">Set the key vault access policy for the Azure AD app</span></span>
1. <span data-ttu-id="07568-109">Festlegen der erweiterten Zugriffsrichtlinien für den Schlüsseltresor</span><span class="sxs-lookup"><span data-stu-id="07568-109">Set key vault advanced access policies</span></span>

### <a name="azure-key-vault"></a><span data-ttu-id="07568-110">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="07568-110">Azure Key Vault</span></span>

<span data-ttu-id="07568-111">Die von ADE verwendeten Verschlüsselungsschlüssel können auf einer Azure Key Vault-Instanz gespeichert werden.</span><span class="sxs-lookup"><span data-stu-id="07568-111">The encryption keys used by ADE can be stored in an Azure Key Vault.</span></span> <span data-ttu-id="07568-112">Azure Key Vault ist ein Tool zum sicheren Speichern und Zugreifen auf Geheimnisse.</span><span class="sxs-lookup"><span data-stu-id="07568-112">Azure Key Vault is a tool for securely storing and accessing secrets.</span></span> <span data-ttu-id="07568-113">Als Geheimnis wird alles bezeichnet, für das Sie den Zugriff streng kontrollieren möchten, z.B. API-Schlüssel, Kennwörter oder Zertifikate.</span><span class="sxs-lookup"><span data-stu-id="07568-113">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="07568-114">Hiermit wird die hoch verfügbare und skalierbare sichere Speicherung in Hardwaresicherheitsmodulen (HSMs) mit Überprüfung gemäß Federal Information Processing Standards (FIPS) 140-2 Level 2 ermöglicht.</span><span class="sxs-lookup"><span data-stu-id="07568-114">This provides highly available and scalable secure storage in Federal Information Processing Standards (FIPS) 140-2 Level 2 validated Hardware Security Modules (HSMs).</span></span> <span data-ttu-id="07568-115">Mit Key Vault erhalten Sie die vollständige Kontrolle über die Schlüssel, die zum Verschlüsseln Ihrer Daten verwendet werden, und Sie können Ihre Schlüsselnutzung verwalten und überwachen.</span><span class="sxs-lookup"><span data-stu-id="07568-115">Using Key Vault, you keep full control of the keys used to encrypt your data, and you can manage and audit your key usage.</span></span> <span data-ttu-id="07568-116">Sie können Ihren Schlüsseltresor über das Azure-Portal, Azure PowerShell und Azure CLI konfigurieren und verwalten.</span><span class="sxs-lookup"><span data-stu-id="07568-116">You can configure and manage your key vault using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

>[!NOTE]
> <span data-ttu-id="07568-117">Für Azure Disk Encryption ist es erforderlich, dass sich Ihre Key Vault-Instanz und Ihre VMs in derselben Azure-Region befinden. So wird sichergestellt, dass Verschlüsselungsgeheimnisse nicht über Grenzen von Regionen hinweg verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="07568-117">Azure Disk Encryption requires that your Key Vault and your VMs are in the same Azure region; this ensures that encryption secrets do not cross regional boundaries.</span></span>

### <a name="azure-ad-application-and-service-principal"></a><span data-ttu-id="07568-118">Azure AD-Anwendung und -Dienstprinzipal</span><span class="sxs-lookup"><span data-stu-id="07568-118">Azure AD application and service principal</span></span>

<span data-ttu-id="07568-119">Zum Zugreifen auf oder Ändern von Ressourcen, z.B. die Verschlüsselungskonfiguration für eine VM mit Skripts oder Code, müssen Sie zuerst eine **Azure Active Directory-Anwendung** einrichten.</span><span class="sxs-lookup"><span data-stu-id="07568-119">To access or modify resources, such as the encryption configuration for a VM with scripts or code, you must first set up an **Azure Active Directory (AD) application**.</span></span> <span data-ttu-id="07568-120">Azure Active Directory (Azure AD) ist ein mehrinstanzenfähiger, cloudbasierter Verzeichnis- und Identitätsverwaltungsdienst, in dem Kernverzeichnisdienste, Anwendungszugriffsverwaltung und Identitätsschutz in nur einer Lösung vereint sind.</span><span class="sxs-lookup"><span data-stu-id="07568-120">Azure Active Directory (Azure AD) is a multi-tenant, cloud-based directory, and identity management service that combines core directory services, application access management, and identity protection into a single solution.</span></span>

<span data-ttu-id="07568-121">Außerdem benötigen Sie einen Azure-**Dienstprinzipal**.</span><span class="sxs-lookup"><span data-stu-id="07568-121">You'll also need an Azure **service principal**.</span></span> <span data-ttu-id="07568-122">Dienstprinzipale sind die Dienstkonten, die Sie zum Ausführen des Skripts oder Codes verwenden. Sie ermöglichen Ihnen das Zuweisen der spezifischen Berechtigungen und des Bereichs, die zum Ausführen der Aufgabe für eine bestimmte Azure-Ressource erforderlich sind.</span><span class="sxs-lookup"><span data-stu-id="07568-122">Service principals are the service accounts you use to run the script or code, and allow you to assign the specific permissions and scope that are needed to run the task against a particular Azure resource.</span></span>

<span data-ttu-id="07568-123">In Azure AD sind zwei Elemente vorhanden: Das Anwendungsobjekt steht für die **_Definition_** der Anwendung (Zweck der Anwendung), und der Dienstprinzipal steht für die **_spezifische Instanz_** der Anwendung.</span><span class="sxs-lookup"><span data-stu-id="07568-123">There are two elements in Azure AD; the application object is the **_definition_** of the application (what it does), and the service principal is the **_specific instance_** of the application.</span></span>

<span data-ttu-id="07568-124">Dieser Ansatz beruht auf dem Prinzip der **geringsten Rechte**. Hierbei werden die Berechtigungen, die der App zugewiesen werden, auf das Minimum beschränkt, das die App zum Durchführen ihrer jeweiligen Aufgaben benötigt.</span><span class="sxs-lookup"><span data-stu-id="07568-124">This approach aligns with the principle of **least privilege**, where the permissions assigned to the app are restricted to the bare minimum required to enable the app to perform its tasks.</span></span>

<span data-ttu-id="07568-125">Sie können Azure AD-Anwendungen und -Dienstprinzipale mit dem Azure-Portal, Azure PowerShell und Azure CLI konfigurieren und verwalten.</span><span class="sxs-lookup"><span data-stu-id="07568-125">You can configure and manage Azure AD applications and service principals using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

### <a name="key-vault-access-policies"></a><span data-ttu-id="07568-126">Key Vault-Zugriffsrichtlinien</span><span class="sxs-lookup"><span data-stu-id="07568-126">Key vault access policies</span></span>

<span data-ttu-id="07568-127">Bevor Sie Verschlüsselungsschlüssel in einer Key Vault-Instanz speichern können, benötigt ADE die Details zur **Client-ID** und zum **Clientgeheimnis** der Azure Active Directory-Anwendung, die über die Berechtigung zum Schreiben in die Key Vault-Instanz verfügt.</span><span class="sxs-lookup"><span data-stu-id="07568-127">Before you can store encryption keys in a Key Vault, ADE requires details on the **Client ID** and the **Client Secret** of the Azure Active Directory application that is permitted to write to the Key Vault.</span></span>

<span data-ttu-id="07568-128">Außerdem müssen Sie den Azure-Zugriff auf die Verschlüsselungsschlüssel in Ihrem Schlüsseltresor angeben, damit sie für die VM zum Starten und Entschlüsseln der Volumes bereitgestellt werden.</span><span class="sxs-lookup"><span data-stu-id="07568-128">You'll also need to provide Azure access to the encryption keys in your key vault, so they are made available to the VM for booting and decrypting the volumes.</span></span>

## <a name="set-key-vault-advanced-access-policies"></a><span data-ttu-id="07568-129">Festlegen der erweiterten Zugriffsrichtlinien für den Schlüsseltresor</span><span class="sxs-lookup"><span data-stu-id="07568-129">Set key vault advanced access policies</span></span>

<span data-ttu-id="07568-130">Mit **erweiterten Zugriffsrichtlinien** wird die Datenträgerverschlüsselung im Schlüsseltresor ermöglicht. Für die Verschlüsselungsbereitstellungen tritt ein Fehler auf, wenn sie nicht vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="07568-130">**Advanced access policies** enable disk encryption on the key vault, and without them, encryption deployments will fail.</span></span> 

<span data-ttu-id="07568-131">Es gibt drei Richtlinien, die aktiviert werden müssen:</span><span class="sxs-lookup"><span data-stu-id="07568-131">There are three policies that need to be enabled:</span></span>

- <span data-ttu-id="07568-132">**Key Vault für die Datenträgerverschlüsselung** Ist für die Azure Disk-Verschlüsselung erforderlich.</span><span class="sxs-lookup"><span data-stu-id="07568-132">**Key Vault for disk encryption** Required for Azure Disk encryption.</span></span>
- <span data-ttu-id="07568-133">**Key Vault für die Bereitstellung** Ermöglicht dem Microsoft.Compute-Ressourcenanbieter das Abrufen von Geheimnissen aus dem Schlüsseltresor. Diese Richtlinie wird beim Erstellen einer VM benötigt.</span><span class="sxs-lookup"><span data-stu-id="07568-133">**Key Vault for deployment** Enables the Microsoft.Compute resource provider to retrieve secrets from the key vault; this policy is needed when creating a VM.</span></span>
- <span data-ttu-id="07568-134">**Key Vault für die Vorlagenbereitstellung (falls erforderlich)** Ermöglicht Azure Resource Manager das Abrufen von Geheimnissen aus dem Schlüsseltresor. Diese Richtlinie ist erforderlich, wenn ARM-Vorlagen für die VM-Bereitstellung verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="07568-134">**Key Vault for template deployment, if needed** Enables Azure Resource Manager to get secrets from the key vault; this policy is required when using ARM templates for VM deployment.</span></span>

<span data-ttu-id="07568-135">Zugriffsrichtlinien für den Schlüsseltresor können mit dem Azure-Portal, Azure PowerShell oder der Azure CLI konfiguriert und verwaltet werden.</span><span class="sxs-lookup"><span data-stu-id="07568-135">Key vault access policies can be configured and managed using the Azure portal, Azure PowerShell, or the Azure CLI.</span></span>

### <a name="what-is-the-azure-disk-encryption-prerequisites-configuration-script"></a><span data-ttu-id="07568-136">Was ist das Konfigurationsskript für die Azure Disk Encryption-Voraussetzungen?</span><span class="sxs-lookup"><span data-stu-id="07568-136">What is the Azure Disk Encryption Prerequisites Configuration Script</span></span>

<span data-ttu-id="07568-137">Mit dem **Konfigurationsskript für die Azure Disk Encryption-Voraussetzungen** werden alle Verschlüsselungsvoraussetzungen (bzw. so viele wie gewünscht) eingerichtet.</span><span class="sxs-lookup"><span data-stu-id="07568-137">The **Azure Disk Encryption Prerequisites Configuration Script** sets up all (or as many as you want) of the encryption prerequisites.</span></span> <span data-ttu-id="07568-138">Mit dem Skript wird auch sichergestellt, dass sich Ihre Key Vault-Instanz in derselben Region wie die zu verschlüsselnde VM befindet.</span><span class="sxs-lookup"><span data-stu-id="07568-138">The script also ensures that your Key Vault is in the same region as the VM you are going to encrypt.</span></span> <span data-ttu-id="07568-139">Es erstellt eine Ressourcengruppe und einen Schlüsseltresor und legt die Zugriffsrichtlinie für den Schlüsseltresor fest.</span><span class="sxs-lookup"><span data-stu-id="07568-139">It will create a resource group, a key vault, and set the key vault access policy.</span></span> <span data-ttu-id="07568-140">Das Skript erstellt darüber hinaus eine Ressourcensperre für den Schlüsseltresor, um zu verhindern, dass er versehentlich gelöscht wird.</span><span class="sxs-lookup"><span data-stu-id="07568-140">The script also creates a resource lock on the key vault to help protect it from accidental deletion.</span></span>

## <a name="encrypting-an-existing-vm-disk"></a><span data-ttu-id="07568-141">Verschlüsseln eines vorhandenen VM-Datenträgers</span><span class="sxs-lookup"><span data-stu-id="07568-141">Encrypting an existing VM disk</span></span>

<span data-ttu-id="07568-142">Die Verschlüsselung eines vorhandenen VM-Datenträgers umfasst zwei Schritte, wenn das **Konfigurationsskript für die Azure Disk Encryption-Voraussetzungen** verwendet wird:</span><span class="sxs-lookup"><span data-stu-id="07568-142">There are two steps for encrypting an existing VM disk, when using the **Azure Disk Encryption Prerequisites Configuration Script**:</span></span>

1. <span data-ttu-id="07568-143">Führen Sie das Konfigurationsskript für die Azure Disk Encryption-Voraussetzungen aus.</span><span class="sxs-lookup"><span data-stu-id="07568-143">Run the Azure disk encryption prerequisites configuration script.</span></span>
1. <span data-ttu-id="07568-144">Verschlüsseln des virtuellen Azure-Computers in PowerShell</span><span class="sxs-lookup"><span data-stu-id="07568-144">Encrypt the Azure virtual machine in PowerShell</span></span>
